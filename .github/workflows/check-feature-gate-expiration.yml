# GitHub Action: Feature Gate Expiration Checker
#
# This workflow checks for feature gates that are due for removal in upcoming
# Kubernetes releases. Add this to your Kubernetes fork at:
#   .github/workflows/check-feature-gate-expiration.yml

name: Feature Gate Expiration Check

on:
  push:
    branches: [main, master, release-*]
    paths:
      - '**/kube_features.go'
  pull_request:
    paths:
      - '**/kube_features.go'
  schedule:
    # Run weekly on Monday at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      upcoming_version:
        description: 'Upcoming Kubernetes version to check (e.g., 1.35)'
        required: true
        default: '1.35'

jobs:
  check-expiring-features:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Determine upcoming version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.upcoming_version }}" >> $GITHUB_OUTPUT
          else
            echo "version=1.35" >> $GITHUB_OUTPUT
          fi
          
      - name: Check for expiring feature gates
        id: check
        run: |
          set +e  # Don't exit on error, we want to capture results
          
          UPCOMING="${{ steps.version.outputs.version }}"
          echo "Checking for features due in Kubernetes $UPCOMING..."
          
          # Parse version
          UPCOMING_MAJOR=$(echo "$UPCOMING" | cut -d. -f1)
          UPCOMING_MINOR=$(echo "$UPCOMING" | cut -d. -f2)
          UPCOMING_NUM=$((UPCOMING_MAJOR * 100 + UPCOMING_MINOR))
          CURRENT_NUM=$((UPCOMING_NUM - 1))
          
          echo "## ðŸ“‹ Feature Gate Expiration Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Checking for version:** $UPCOMING" >> $GITHUB_STEP_SUMMARY
          echo "**Current version:** 1.$((UPCOMING_MINOR - 1))" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find feature files and extract expiration info
          OVERDUE_COUNT=0
          DUE_COUNT=0
          OVERDUE_LIST=""
          DUE_LIST=""
          
          for file in $(find . -name "kube_features.go" -type f | grep -v vendor); do
            echo "Processing: $file"
            
            # Extract features with removal comments using awk
            awk -v upcoming_num="$UPCOMING_NUM" -v current_num="$CURRENT_NUM" '
            BEGIN { feature = ""; in_block = 0 }
            /^[[:space:]]*[A-Za-z][A-Za-z0-9_]*:[[:space:]]*\{/ {
                gsub(/^[[:space:]]+/, "")
                gsub(/:[[:space:]]*\{.*/, "")
                feature = $0
                in_block = 1
                next
            }
            /^[[:space:]]*[a-z]+features\.[A-Za-z][A-Za-z0-9_]*:[[:space:]]*\{/ {
                gsub(/^[[:space:]]+/, "")
                gsub(/:[[:space:]]*\{.*/, "")
                feature = $0
                in_block = 1
                next
            }
            in_block && /[Rr]emove.*[0-9]+\.[0-9]+/ {
                line = $0
                if (match(line, /[0-9]+\.[0-9]+/)) {
                    ver = substr(line, RSTART, RLENGTH)
                    split(ver, v, ".")
                    num = v[1] * 100 + v[2]
                    if (num < current_num) {
                        print "OVERDUE|" feature "|" ver
                    } else if (num == upcoming_num) {
                        print "DUE|" feature "|" ver
                    }
                }
            }
            /^[[:space:]]*\},?[[:space:]]*$/ && in_block {
                in_block = 0
                feature = ""
            }
            ' "$file" | sort -u | while IFS='|' read -r status feat ver; do
              if [ "$status" = "OVERDUE" ]; then
                echo "OVERDUE: $feat (planned removal: $ver)"
                echo "OVERDUE|$feat|$ver" >> /tmp/overdue_features.txt
              elif [ "$status" = "DUE" ]; then
                echo "DUE: $feat (planned removal: $ver)"
                echo "DUE|$feat|$ver" >> /tmp/due_features.txt
              fi
            done
          done
          
          # Count results
          if [ -f /tmp/overdue_features.txt ]; then
            OVERDUE_COUNT=$(wc -l < /tmp/overdue_features.txt)
          fi
          if [ -f /tmp/due_features.txt ]; then
            DUE_COUNT=$(wc -l < /tmp/due_features.txt)
          fi
          
          # Output results to summary
          if [ "$OVERDUE_COUNT" -gt 0 ]; then
            echo "### ðŸš¨ OVERDUE Features ($OVERDUE_COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Feature | Planned Removal | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-----------------|--------|" >> $GITHUB_STEP_SUMMARY
            while IFS='|' read -r _ feat ver; do
              echo "| $feat | $ver | **OVERDUE** |" >> $GITHUB_STEP_SUMMARY
            done < /tmp/overdue_features.txt
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$DUE_COUNT" -gt 0 ]; then
            echo "### âš ï¸ Features Due in $UPCOMING ($DUE_COUNT)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Feature | Planned Removal | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-----------------|--------|" >> $GITHUB_STEP_SUMMARY
            while IFS='|' read -r _ feat ver; do
              echo "| $feat | $ver | Due |" >> $GITHUB_STEP_SUMMARY
            done < /tmp/due_features.txt
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$OVERDUE_COUNT" -eq 0 ] && [ "$DUE_COUNT" -eq 0 ]; then
            echo "### âœ… No Features Due" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No feature gates are overdue or due for removal in $UPCOMING" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Generated on $(date -u '+%Y-%m-%d %H:%M UTC')_" >> $GITHUB_STEP_SUMMARY
          
          # Print summary to console
          echo ""
          echo "=== SUMMARY ==="
          echo "Overdue: $OVERDUE_COUNT"
          echo "Due in $UPCOMING: $DUE_COUNT"
          
          # Emit warnings (visible in GitHub Actions UI)
          if [ "$OVERDUE_COUNT" -gt 0 ]; then
            echo "::warning::Found $OVERDUE_COUNT overdue feature gates that should have been removed"
          fi
          if [ "$DUE_COUNT" -gt 0 ]; then
            echo "::warning::Found $DUE_COUNT feature gates due for removal in $UPCOMING"
          fi
          
          # Clean up
          rm -f /tmp/overdue_features.txt /tmp/due_features.txt
          
          # Exit 0 so workflow shows as success (with warnings)
          # Change to: exit 1 if you want the workflow to fail when features are found
          exit 0
